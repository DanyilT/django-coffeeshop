# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # Expose services on localhost (different ports than coffeeshop)
  config.vm.network "forwarded_port", guest: 80,   host: 8081, auto_correct: true
  config.vm.network "forwarded_port", guest: 1080, host: 1081, auto_correct: true

  # Mount secrets folder from repo root
  config.vm.synced_folder "../secrets/", "/secrets"

  # Provisioning scripts
  config.vm.provision :shell, path: "bootstrap.sh"
  config.vm.provision "shell", run: "always", path: "reboot-provision.sh"

  # === Docker Provider ===
  config.vm.provider "docker" do |docker, override|
    docker.build_dir       = "."      # build from ./Dockerfile (this folder)
    docker.remains_running = true
    docker.has_ssh         = true
    docker.privileged      = true

    # Port mapping - Using 8081/1081 to avoid conflict with coffeeshop (8080/1080)
    docker.ports           = ["8081:80", "1081:1080"]

    # SSH configuration - CRITICAL for Docker provider to work
    override.ssh.username   = "vagrant"
    override.ssh.password   = "vagrant"
    override.ssh.insert_key = false
  end

  config.vm.boot_timeout = 600
end